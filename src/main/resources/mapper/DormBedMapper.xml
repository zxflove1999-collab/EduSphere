<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.campus.mapper.DormBedMapper">

    <resultMap id="BaseResultMap" type="com.example.campus.entity.DormBed">
        <id column="bed_id" property="bedId"/>
        <result column="room_id" property="roomId"/>
        <result column="bed_number" property="bedNumber"/>
        <result column="bed_status" property="bedStatus"/>
        <result column="current_resident_id" property="currentResidentId"/>
        <result column="allocation_time" property="allocationTime"/>
    </resultMap>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM t_dorm_bed WHERE bed_id = #{bedId}
    </select>

    <select id="selectByRoomId" resultMap="BaseResultMap">
        SELECT * FROM t_dorm_bed WHERE room_id = #{roomId} ORDER BY bed_number
    </select>

    <select id="selectAvailableBeds" resultMap="BaseResultMap">
        SELECT * FROM t_dorm_bed 
        WHERE room_id = #{roomId} AND bed_status = 1
        ORDER BY bed_number
    </select>

    <select id="selectByResidentId" resultMap="BaseResultMap">
        SELECT * FROM t_dorm_bed WHERE current_resident_id = #{residentId} AND bed_status = 2
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="bedId">
        INSERT INTO t_dorm_bed (room_id, bed_number, bed_status, current_resident_id, allocation_time)
        VALUES (#{roomId}, #{bedNumber}, #{bedStatus}, #{currentResidentId}, #{allocationTime})
    </insert>

    <update id="update">
        UPDATE t_dorm_bed
        <set>
            <if test="roomId != null">room_id = #{roomId},</if>
            <if test="bedNumber != null">bed_number = #{bedNumber},</if>
            <if test="bedStatus != null">bed_status = #{bedStatus},</if>
            <if test="currentResidentId != null">current_resident_id = #{currentResidentId},</if>
            <if test="allocationTime != null">allocation_time = #{allocationTime},</if>
        </set>
        WHERE bed_id = #{bedId}
    </update>

    <update id="updateStatus">
        UPDATE t_dorm_bed
        SET bed_status = #{bedStatus},
            current_resident_id = #{residentId},
            allocation_time = CASE
                                WHEN #{bedStatus} = 2 THEN #{allocationTime}
                                ELSE NULL
                              END
        WHERE bed_id = #{bedId}
    </update>

    <delete id="deleteById">
        DELETE FROM t_dorm_bed WHERE bed_id = #{bedId}
    </delete>

    <select id="selectGlobalAvailableBeds" resultType="map">
        SELECT b.bed_id,
               b.room_id,
               b.bed_number
        FROM t_dorm_bed b
        INNER JOIN t_dorm_room r ON b.room_id = r.room_id
        WHERE b.bed_status = 1
        <if test="buildingId != null">
            AND r.building_id = #{buildingId}
        </if>
        ORDER BY r.room_id, b.bed_number
    </select>

    <select id="selectStudentsWithoutBed" resultType="long">
        SELECT u.user_id
        FROM t_user u
        INNER JOIN t_student_profile sp ON u.user_id = sp.user_id
        WHERE u.status = 1
          AND NOT EXISTS (
            SELECT 1
            FROM t_dorm_bed b
            WHERE b.current_resident_id = u.user_id
              AND b.bed_status = 2
          )
        ORDER BY u.created_at
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>

