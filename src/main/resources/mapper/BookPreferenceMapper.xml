<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.campus.mapper.BookPreferenceMapper">

    <resultMap id="BaseResultMap" type="com.example.campus.entity.BookPreference">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="recommended_book_id" property="recommendedBookId"/>
        <result column="reason" property="reason"/>
        <result column="score" property="score"/>
        <result column="generated_at" property="generatedAt"/>
    </resultMap>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM t_book_preference WHERE id = #{id}
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT bp.*, b.title, b.author, b.cover_url
        FROM t_book_preference bp
        INNER JOIN t_book b ON bp.recommended_book_id = b.book_id
        WHERE bp.user_id = #{userId}
        ORDER BY bp.score DESC, bp.generated_at DESC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_book_preference (user_id, recommended_book_id, reason, score, generated_at)
        VALUES (#{userId}, #{recommendedBookId}, #{reason}, #{score}, NOW())
    </insert>

    <update id="update">
        UPDATE t_book_preference
        <set>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="recommendedBookId != null">recommended_book_id = #{recommendedBookId},</if>
            <if test="reason != null">reason = #{reason},</if>
            <if test="score != null">score = #{score},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM t_book_preference WHERE id = #{id}
    </delete>

    <delete id="deleteByUserId">
        DELETE FROM t_book_preference WHERE user_id = #{userId}
    </delete>

</mapper>

